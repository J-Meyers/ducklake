# name: test/sql/rewrite_data_files/test_last_snapshot_rewrite.test
# description: Test ducklake_rewrite_data_files
# group: [rewrite_data_files]

require ducklake

require parquet

statement ok
ATTACH 'ducklake:__TEST_DIR__/ducklake_rewrite_data.db' AS ducklake (DATA_PATH '__TEST_DIR__/ducklake_rewrite_data', METADATA_CATALOG 'ducklake_metadata')

statement ok
USE ducklake

# Start off with simple case
statement ok
CREATE TABLE test(key INTEGER, values VARCHAR);

statement ok
INSERT INTO test SELECT i, concat('thisisastring_', i) FROM range(10000) t(i)

# Let's do three rounds of deletions

statement ok
DELETE FROM test
WHERE key < 1000;

statement ok
DELETE FROM test
WHERE key > 9000;

statement ok
DELETE FROM test
WHERE key > 5000;

statement ok
CALL ducklake_rewrite_data_files('ducklake', 'test', delete_threshold => 0.95);


# What if we have multiple files?
# Let's do partitions
