# name: test/sql/rewrite_data_files/test_rewrite_db.test
# description: Test calling the delete rewrite function multiple times, over a series of deletes, test the threshold parameter behaves well
# group: [rewrite_data_files]

require ducklake

require parquet

statement ok
ATTACH 'ducklake:__TEST_DIR__/rewrite_db.db' AS ducklake (DATA_PATH '__TEST_DIR__/rewrite_db', METADATA_CATALOG 'ducklake_metadata')

statement ok
USE ducklake

loop i 0 2

statement ok
CREATE TABLE test_${i} (key INTEGER, values VARCHAR);

# 2	{tables_inserted_into=[1]}
statement ok
INSERT INTO test_${i}  SELECT i, concat('thisisastring_', i) FROM range(100) t(i)

# Let's do a few insertions interleaved with deletions
# 3	{tables_deleted_from=[1]}
statement ok
DELETE FROM test_${i}
WHERE key < 50;

# 4	{tables_inserted_into=[1]}
statement ok
INSERT INTO test_${i}  SELECT i, concat('thisisastring_', i) FROM range(100,200) t(i)

# 5	{tables_deleted_from=[1]}
statement ok
DELETE FROM test_${i}
WHERE key < 80;

# 6	{tables_deleted_from=[1]}
statement ok
DELETE FROM test_${i}
WHERE key  = 120;

endloop

statement ok
CALL ducklake_rewrite_data_files(delete_threshold => 0);

query III
SELECT data_file_id, begin_snapshot, end_snapshot FROM ducklake_metadata.ducklake_data_file
----
0	2	5
4	5	NULL