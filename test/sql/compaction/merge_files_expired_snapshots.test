# name: test/sql/compaction/merge_files_expired_snapshots.test
# description: test ducklake merges files from expired snapshots if they also belong to current snapshot
# group: [compaction]

require ducklake

require parquet

statement ok
ATTACH 'ducklake:__TEST_DIR__/ducklake_merge_expire_snapshots_schema.db' AS ducklake

statement ok
USE ducklake;

statement ok
CREATE TABLE example (key VARCHAR, value VARCHAR);

statement ok
INSERT INTO example (key, value) VALUES ('foo', 'bar');

statement ok
INSERT INTO example (key, value) VALUES ('baz', 'qux');

query II
SELECT snapshot_id, changes FROM snapshots();
----
0	{schemas_created=[main]}
1	{tables_created=[main.example]}
2	{tables_inserted_into=[1]}
3	{tables_inserted_into=[1]}

query I
SELECT count(*) FROM ducklake_list_files('ducklake', 'example');
----
2

statement ok
CALL ducklake_expire_snapshots('ducklake', versions => [2]);

query I
SELECT count(*) FROM ducklake_list_files('ducklake', 'example');
----
2

statement ok
CALL ducklake.merge_adjacent_files();

query I
SELECT count(*) FROM ducklake_list_files('ducklake', 'example');
----
1

query II
FROM example
----
foo	bar
baz	qux
