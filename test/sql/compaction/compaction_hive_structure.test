# name: test/sql/compaction/compaction_hive_structure.test
# description: test compaction keeps hive structure
# group: [compaction]

require ducklake

require parquet

statement ok
ATTACH 'ducklake:__TEST_DIR__/ducklake_compaction_hive.db' AS ducklake

statement ok
use ducklake

statement ok
CREATE TABLE sales (
      id INTEGER,
      product STRING,
      amount DOUBLE,
      sale_date DATE
  );

statement ok
ALTER TABLE sales SET PARTITIONED BY (sale_date);

statement ok
INSERT INTO sales
  VALUES
      (1, 'Product A', 100.0, '2023-07-01'),
      (2, 'Product B', 150.0, '2023-07-01');

statement ok
INSERT INTO sales
  VALUES
      (3, 'Product A', 100.0, '2023-07-02'),
      (4, 'Product B', 150.0, '2023-07-02');

statement ok
INSERT INTO sales
  VALUES
      (5, 'Product C', 300.0, '2023-07-02'),
      (6, 'Product B', 150.0, '2023-07-02');

statement ok
CALL merge_adjacent_files();

statement ok
CALL ducklake_cleanup_old_files('ducklake', cleanup_all => true);

query I
SELECT count(*) FROM __ducklake_metadata_ducklake.ducklake_data_file where path like '%/%' OR path LIKE '%\%';
----
2

query IIII
FROM sales
----
1	Product A	100.0	2023-07-01
2	Product B	150.0	2023-07-01
3	Product A	100.0	2023-07-02
4	Product B	150.0	2023-07-02
5	Product C	300.0	2023-07-02
6	Product B	150.0	2023-07-02