# name: test/sql/remove_orphans/remove_orphaned_files.test
# description: Test the removal of orphaned files
# group: [remove_orphans]

require ducklake

require parquet

# partitioning based on a column
statement ok
ATTACH 'ducklake:__TEST_DIR__/remove_orphaned_files.db' AS ducklake (DATA_PATH '__TEST_DIR__/remove_orphaned_files', METADATA_CATALOG 'ducklake_metadata')

statement ok
USE ducklake

statement ok
CREATE TABLE test (a integer)

statement ok
insert into test values (1);

statement ok
insert into test values (2);

statement ok
CALL ducklake_merge_adjacent_files('ducklake');

# Add orphaned file
statement ok
COPY test to '__TEST_DIR__/remove_orphaned_files/main/test/bla.parquet';

# We should have 3 files
query I
SELECT COUNT(*) FROM GLOB('__TEST_DIR__/remove_orphaned_files/main/test/*')
----
4

statement ok
CALL ducklake_delete_orphaned_files('ducklake', cleanup_all => true, dry_run => true);



